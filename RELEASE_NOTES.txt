# Release Notes - Dial-A-Charmer

## v0.8.4-beta (2026-02-14) - "Stability, Cleanup & Documentation Sync"
- **Stability (Boot/WDT):**
    - Added configurable watchdog diagnostics (`APP_WDT_DIAG_LOG`, loop warning threshold, heartbeat interval).
    - Added boot-context, loop-stall, and heartbeat telemetry for `app_main` and input task.
- **GPIO Robustness:**
    - Fixed rotary input initialization to avoid invalid internal pull-up configuration on input-only GPIOs.
    - Added guarded pin configuration with explicit warning/error logging.
- **Audio Behavior:**
    - Removed automatic suppression of system sounds during Night Mode.
    - Night Mode now uses configured base-speaker night volume and LED night profile.
    - Consolidated audio transition routines (mute / pipeline stop-reset) to reduce duplicate state paths.
- **Codebase Simplification:**
    - Added shared utility layer for language lookup, WAV fallback discovery, and LED settings load/store/clamp.
    - Unified LED settings handling between firmware core and web API.
    - Migrated timer/alarm runtime flags to structured state containers.
    - Removed unused constants and stale declarations.
- **Configuration/Pin Consistency:**
    - Unified PA pin source to app configuration (`APP_PIN_PA_ENABLE`).
    - Replaced hardcoded audio timing/fade literals with config macros.
- **Docs:**
    - Updated README and quick reference to match current dial codes, Night Mode behavior, AP name, defaults, and file naming.

## v0.8.3-beta (2026-01-31) - "Performance & UX Update"
- **Scan-on-Demand (Fast Boot)**:
    - Removed the slow automatic SD card scan on every boot. The device now boots instantly and loads cached playlists.
    - Added **Dial Code 95** to manually trigger a full re-index / scan of the SD card. This is only necessary if you add files manually without using the helper scripts.
    - During re-indexing, the Web Interface is temporarily suspended to maximize scanning speed.
    - Removed the "Reindex" button from the Web Interface; this function is now exclusively available via the Dial (for privacy/security).
- **Phonebook Updates**:
    - Added "Re-Index SD" (95) to the internal phonebook documentation.

## v0.8.2-beta (2026-01-31) - "Audio Logic Refinements"
- **Audio Routing Engine Overhaul**: Fixed silent handset issues by rearchitecting the output logic for ES8388 codecs.
- **Channel Isolation**: Implemented pure digital isolation. Handset Mode now digitally mutes the Speaker channel (Right) and Speaker Mode mutes the Handset channel (Left), fixing volume bleed-over.
- **Volume Control Fix**: The Web Interface sliders ("Base Volume" vs "Handset Volume") now work independently and correctly thanks to mode-aware volume handling.
- **PA Logic Update**: The Power Amplifier (PA) signal is now kept permanently enabled to prevent accidental muting of the headphone stage on certain hardware revisions.
- **Codebase Cleanup**: Removed legacy debug code and optimized audio task structure.

## v0.8.1-beta (2026-01-23) - "Fortune & Mix Refinements"
- **Phonebook Updates**:
    - Persona 5 reserved for **Fortune Cookie** (Dial `5`).
    - **Random Mix** moved to Dial `6` and always present.
- **Random Mix Persistence**:
    - Mix order and progress are now stored on SD to avoid repeats across reboots until all tracks have played.
- **mDNS Reliability**:
    - Hostname set explicitly and mDNS is reinitialized on reconnect to improve `dial-a-charmer.local` stability.
- **Build Quality**:
    - C++17 enabled to remove compiler warnings about structured bindings.

## v0.7.2-beta (2026-01-19) - "The Golden Master Update"
- **Hardware Support**:
    - **Ai-Thinker Audio Kit v2.2**: Full support added including pin mappings for onboard peripherals (ES8388 Codec, SD Slot, Keys).
- **Core Improvements**:
    - **Robust Dialing Logic**: Switched rotary input handling to use the secondary "State Contact" (Mode Pin). This eliminates timing-based errors and allows indefinitely pausing while winding the dial.
    - **Code Cleanup**: Removed deprecated `CMD_LOOP` logic, inactive battery checks, and vibration motor code to streamline the codebase.
    - **Documentation**: Comprehensive update to README with dual-board pinout tables and simplified feature overview.


## v0.8.0-beta (2026-01-18) - "The Polish & Privacy Update"
- **Status**: **BETA** (Awaiting Hardware Validation)
- **Busy Tone Feature**:
    - "Off-Hook Timeout": If the handset is lifted but no number dialed for 5 seconds, a busy signal loop plays.
    - Prevents undefined states. Dialing is blocked until hung up.
    - **Snooze Exception**: Snooze mode keeps the handset silent (no busy tone) to allow "putting the phone aside".
- **Performance**:
    - **Non-Blocking Storage**: Refactored the "Reindex Storage" web operation. It now runs asynchronously in the background loop instead of blocking the web server request (which previously caused timeouts).
    - **Non-Blocking Audio**: Converted "Time Speaking" logic to a Queue system. The main loop no longer freezes while the device speaks dates or confirmations.
    - **Reduced Logging**: Stripped debug output for cleaner serial terminal behavior.
- **Stability Fixes**:
    - **Audio Queue Management**: Fixed "stale queue" issues where interrupted sentences would play back randomly later.
    - **Boot Safety**: Added explicit wait-state during boot to prevent crashes if the Audio Task initializes slowly.
    - **Volume Guard**: Ensured volume resets to defaults after alarm termination.
    - **Config Safety**: Added automated fix for invalid Dial Tone configurations.
- **Licensing**:
    - Applied **PolyForm Noncommercial License 1.0.0** to the repository (see [README.md](README.md)).

## v0.7.1-beta (2026-01-18) - "The Voice Feedback Update"
- **Enhanced Voice Navigation**:
    - **Base Speaker confirmation** when canceling timers or deleting manual alarms.
    - Added dedicated voice prompts for "Timer Cancelled" and "Alarm Deleted".
- **Hardware Controls**:
    - **Timer Cancel**: Lifting the handset instantly cancels any running timer (with voice confirmation).
    - **Manual Alarm Delete**: Holding the extra button **while lifting the handset** deletes the manual alarm.
- **Dial Codes**:
    - **Dial 90**: Explicit code to toggle ALL alarms.
    - **Dial 91**: Explicit code to toggle "Skip Next Alarm".

## v0.7.0-beta (2026-01-18) - "The Robustness Update"
- **Audio Multithreading**: Moved audio decoding to dedicated Core 0 task. Prevents stuttering during Web UI usage or heavy WiFi traffic.
- **Fail-Safe Features**:
    - **NVS Persistence**: Alarms now survive device reboots.
    - **RTC Support**: Added DS3231 support for timekeeping during internet outages.
    - **Fallback Tone**: Synthesized alarm tone generated if SD card files are missing.
- **Detailed Announcements**: Extended `speakTime()` to announce Weekday, Date, Month, Year, and DST status.
- **Improved Scripts**: Generator script now creates localized calendar audio assets.

## v0.6.0-beta (2026-01-18) - "The Streamlined Specialist"
- **Hardware Cleanup (GPS Removal)**:
    - Removed all dependencies on GNSS/GPS hardware (u-blox M10).
    - Timekeeping now relies exclusively on **NTP (Network Time Protocol)** via Wi-Fi.
    - Removed `TinyGPS++` library and associated UART handling code to reduce firmware size and complexity.
    - Updated `config.h` and pin definitions to reflect the hardware changes.
- **Web Interface 2.0 (SPA)**:
    - **Single Page Application**: The Web Manager now serves a static `index.html` from the device's SPIFFS filesystem instead of generating HTML strings in C++.
    - **Performance**: Faster load times and cleaner code separation between frontend (HTML/JS) and backend (API).
    - **Optimization**: Added `generate_mockups.py` and file serving logic to support the new architecture.
- **System Stability**:
    - **Watchdog Timer**: Implemented ESP32 Task Watchdog (WDT) with a 20-second timeout to automatically reset the device in case of system freeze.
    - **Audio Tools**: Updated `split_audio.py` with High-Pass Filtering and intelligent noise thresholding (-25dB) for cleaner audio segmenting.
- **Bug Fixes**:
    - Fixed `esp_task_wdt_init` compilation error by updating to the correct `esp_task_wdt_config_t` structure.
    - Fixed Web UI dropdowns showing file extensions.

## v0.5.0-beta (2026-01-16) - "The Intelligent Timekeeper"
- **Dual Alarm System**: 
    - **Single Alarm**: Priority alarm set via Rotary Dial (one-time use).
    - **Repeating Alarm**: Weekday-aware alarm schedule set via Web Interface.
    - **Skip Next Logic**: Dial `9 1` to skip the next scheduled recurring alarm without disabling the schedule entirely.
- **Enhanced Web Interface**:
    - **Split Design**: Separated into "Basic" (Home) and "Advanced" views to declutter usage.
    - **Previews**: Added ability to listen to Ringtones and Dial Tones directly in the browser.
    - **OTA Update**: Firmware can now be updated directly via the Advanced Settings page.
    - **Snooze Config**: Snooze duration is now user-configurable (0-20 mins).
- **AI & Directory**:
    - **Gemini AI Integration**: Phonebook entries can now trigger dynamic AI responses (e.g. "Tell me a joke").
    - **Phonebook API**: Full management of contacts/functions via JSON API.

## v0.4.0-beta (2026-01-16) - "The Conversationalist"
- **Audio Intelligence**:
    - **Half-Duplex AEC**: Implemented automatic microphone muting during audio playback to prevent echo and self-triggering when using Gemini AI.
    - **Interruption Logic**: Users can now stop playback/TTS instantly by pressing the Extra Button or placing the receiver on the hook.
- **Microphone Control**:
    - Added driver support for ES8311 ADC Volume/Mute control.
    - Automatic mute/unmute management in main loop.

## v0.3.0-alpha (2026-01-16)
- **Core System Architecture**:
    - **Hardware Conflict Resolution**: Migrated to `Adafruit_NeoPixel` to resolve FastLED/I2S timing conflicts. 
    - **Partitioning**: Upgraded to `huge_app.csv` to support larger OTA binaries.
    - **Pin Mapping**: Optimized pinout for Ai-Thinker ESP32 Audio Kit v2.2 (ES8388 codec, dial mode on GPIO 36).
    - **Project Renaming**: Officially renamed to "Dial-A-Charmer".

- **Audio & Content**:
    - **Persona Playlists**: Implemented "Style" dialing (1=Trump, 2=Badran, 3=Yoda, 4=Neutral).
    - **Smart Shuffle**: Non-repeating playback logic for categories.
    - **Local Priority**: System prefers offline MP3s over TTS to ensure responsiveness.
    - **Tools**: Added `split_audio.py` for automated content preparation.

- **User Interaction**:
    - **Multi-Language**: Full DE/EN switching for prompts and TTS.
    - **Alarm Clock**: Hold-Button + 4-digit input (0730) to set daily alarms.
    - **Volume Control**: Independent sliders for Handset (Voice) and Ringer (Alarm) in WebUI.
    - **Night Mode**: Schedule-based LED dimming.

- **Web & Deployment**:
    - **Web Installer**: Browser-based flashing (ESP Web Tools).
    - **OTA**: Fully automated GitHub Actions workflow for builds.

## v0.1.0-alpha (Initial Release)
- **Core Functionality**:
  - Atomic Clock synchronization via GNSS (M10 module).
  - Rotary Dial input processing (Pulse counting with debounce).
  - Hook Switch and Extra Action Button support.
  - Audio playback via I2S (MAX98357A/PCM5102) from SD Card.
- **Features**:
  - **Timer/Alarm**: Set countdowns using the rotary dial when the receiver is on the hook.
  - **Compliment Dispenser**: Dial numbers (1-9) when the receiver is off the hook to hear compliments.
  - **Time Announcement**: Dial 0 when receiver is off the hook to hear the current time.
  - **Web Interface**: Captive Portal (Access Point "DialACharmer") for configuring Wi-Fi credentials and Timezone offset.
  - **Status LED**: WS2812 indication for boot, Wi-Fi status, and GNSS lock.
- **Configuration**:
  - Centralized `include/config.h` for all hardware pins and system constants.
  - Persistent settings (Wi-Fi, Timezone) saved to Flash memory.
  - Standalone operation (No external servers/Home Assistant required).
